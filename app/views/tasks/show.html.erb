<div class="task-detail-container">
  <div class="task-card">
    <div class="task-header">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <%# タイプのバッジ（タスク or 予定） %>
        <span class="type-badge type-<%= @task.task_type %>" style="font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: #eee; color: #666;">
          <%= @task.task_type_i18n %>
        </span>
        <%# 優先度バッジ %>
        <span class="priority-badge priority-<%= @task.priority %>">
          <%= @task.priority_i18n if @task.priority %>
        </span>
      </div>
      <h2><%= @task.title %></h2>
    </div>

    <div class="task-body">
      <% if @task.todo? %>
        <%# タスク（締切）の場合 %>
        <div class="info-group">
          <label>期限</label>
          <p><%= @task.deadline&.strftime("%Y年%m月%d日 %H:%M") || "未設定" %></p>
        </div>
        <p>
        <strong>ステータス:</strong>
         <span class="status-label status-<%= @task.status %>">
          <%= I18n.t "enums.task.status.#{@task.status}" %>
         </span>
        </p>
      <% else %>
        <%# 予定（期間）の場合 %>
        <div class="info-group">
          <label>日時</label>
          <p>
            <%= @task.start_at&.strftime("%Y年%m月%d日 %H:%M") %> 〜 
            <br>
            <%= @task.end_at&.strftime("%Y年%m月%d日 %H:%M") %>
          </p>
        </div>
      <% end %>

      <div class="info-group">
        <label>メモ</label>
        <%# labelは常に出し、pタグの中身だけ条件分岐させます %>
        <p>
          <%= simple_format(@task.description) if @task.description.present? %>
        </p>
      </div>
    </div>

    <hr>
<h4>コメント</h4>

<div id="comments">
  <% @task.comments.each do |comment| %>
    <div class="comment" style="margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
      <strong><%= comment.user.name %></strong>: 
      <%= comment.content %>
      <small class="text-muted">(<%= l comment.created_at, format: :short %>)</small>

      <%# 権限がある場合のみ削除ボタンを表示 %>
      <% if comment.user == current_user || @task.teams.any? { |team| current_user.leader_of?(team) } %>
        <%= link_to "削除", task_comment_path(@task, comment), 
                    data: { turbo_method: :delete, turbo_confirm: "コメントを削除しますか？" }, 
                    class: "text-danger", style: "font-size: 0.8rem; margin-left: 10px;" %>
      <% end %>
    </div>
  <% end %>
</div>

<hr>

<%= form_with(model: [@task, Comment.new], local: true) do |f| %>
  <div class="mb-3">
    <%= f.text_area :content, class: "form-control", placeholder: "コメントを入力..." %>
  </div>
  <%= f.submit "投稿する", class: "btn btn-primary" %>
<% end %>

    <div class="task-actions">
      <%= link_to "編集する", edit_task_path(@task), class: "btn-edit" %>
      <%= link_to "削除する", task_path(@task), 
                  data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" }, 
                  class: "btn-delete" %>
      <%= link_to "カレンダーに戻る", tasks_path, class: "btn-back" %>
    </div>
  </div>
</div>