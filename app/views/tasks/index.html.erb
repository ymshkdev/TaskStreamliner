<%# 1. „É¶„Éº„Ç∂„ÉºÂêçË°®Á§∫ %>
<div class="user-info" style="margin-bottom: 20px;">
  <h2 style="font-size: 1.2rem; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
    <%= current_user.name %> „Åï„Çì„ÅÆÊâãÂ∏≥
  </h2>
</div>

<%# 2. CSSË™≠„ÅøËæº„Åø %>
<%= stylesheet_link_tag "tasks_index" %>

<%# 3. „Ç´„É¨„É≥„ÉÄ„Éº„Å®„Çµ„Ç§„Éâ„Éê„Éº„ÇíÂõ≤„ÇÄÊ®™‰∏¶„Å≥„Ç≥„É≥„ÉÜ„Éä %>
<div class="dashboard-layout" data-controller="sidebar" data-sidebar-target="container">
  <%# Èñã„Åè„Éú„Çø„É≥ %>
  <button type="button" class="toggle-button" data-action="click->sidebar#toggle">
    ‚ò∞ <small>„É°„Éã„É•„Éº</small>
  </button>

  <%# „Çµ„Ç§„Éâ„Éê„ÉºÊú¨‰Ωì %>
  <aside class="task-sidebar">
    <%= render 'sidebar', todo_list: @todo_list %>
  </aside>

  <%# „Çµ„Ç§„Éâ„Éê„Éº„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÊôÇ„Å†„ÅëÂá∫„Çã„ÄåËÉåÊôØ„ÅÆÈªí„ÅÑÂΩ±„Äç %>
  <div class="sidebar-overlay" data-action="click->sidebar#close"></div>

  <%# --- Âè≥Ôºö„Ç´„É¨„É≥„ÉÄ„Éº„Ç≥„É≥„ÉÜ„Éä --- %>
  
  <div class="calendar-container" style="flex: 1; min-width: 0;">
  
  <%= month_calendar(events: @tasks, attribute: :start_time, start_date: @start_date) do |date, tasks| %>
    
    <div class="day-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
     <%# Â∑¶ÂÅ¥ÔºöÊó•‰ªò„Å®Á•ùÊó•Âêç %>
     <div>
       <%# span„Å´day-number„ÇØ„É©„Çπ„ÇíËøΩÂä†„Åó„Å¶„ÄÅÂúüÊó•„ÅÆËâ≤Ë®≠ÂÆö„ÅåÂäπ„Åè„Çà„ÅÜ„Å´„Åô„Çã HolidayJp.holiday?(date) „ÅßÁ•ùÊó•Âà§ÂÆö„ÄÇÁ•ùÊó•„Å™„Çâ 'holiday' „ÇØ„É©„Çπ„Çí„Å§„Åë„Çã %>
       <span class="day-number <%= 'sun' if date.sunday? %> <%= 'sat' if date.saturday? %> <%= 'holiday' if HolidayJp.holiday?(date) %>">
        <%# Êó•‰ªò„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„Çâ„Åù„ÅÆÊó•„ÅÆË©≥Á¥∞„Éö„Éº„Ç∏ÔºàÂæå„Åª„Å©‰ΩúÊàêÔºâ„Å∏È£õ„Å∞„Åô„Åü„ÇÅ„ÅÆ„É™„É≥„ÇØÔºà‰ªä„ÅØ‰ªÆ„Å´new„Å∏Ôºâ %>
        <%= link_to date.day, day_tasks_path(date: date), style: "text-decoration: none; color: inherit;" %>
       </span>
      <%# Á•ùÊó•Âêç„ÇíË°®Á§∫„Åô„Çã %>
      <% if holiday = HolidayJp.between(date, date).first %>
       <div class="holiday-name" style="font-size: 0.6rem; color: #d32f2f; margin-top: 2px;">
        <%= holiday.name %>
       </div>
      <% end %>
     </div>
     <%# Âè≥ÂÅ¥ÔºöÔºã„Éû„Éº„ÇØÔºàÊñ∞Ë¶èÁôªÈå≤„Éö„Éº„Ç∏„Å∏Ôºâ %>
     <%= link_to new_task_path(selected_date: date), class: "add-task-btn", title: "Êñ∞Ë¶èÁôªÈå≤", style: "text-decoration: none; color: #999;" do %>
      <span class="plus-icon" style="font-size: 1.2rem; line-height: 1;">&plus;</span>
     <% end %>
   </div>

    <div class="day-body">
      <% tasks.each do |task| %>
       <div class="task-entry <%= task.task_type %> <%= "status-#{task.status}" if task.todo? %>" data-team-id="<%= task.teams.first&.id %>">
        <%# ‰∫àÂÆöÔºàscheduleÔºâ„Åã„Å§ÈñãÂßãÊôÇÈñì„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅÈñãÂßãÊôÇÈñì(HH:mm)~ÁµÇ‰∫ÜÊôÇÈñì(HH:mm)„ÇíË°®Á§∫ %>
        <% if task.schedule? && task.start_at.present? %>
         <span style="font-size: 0.8em; color: #666;">
          <%= task.start_at.strftime("%H:%M") %> „Äú <%= task.end_at.strftime("%H:%M") %>
         </span>
        <% end %>

        <%# --- „Çø„Çπ„ÇØ (todo) „ÅÆÂ†¥ÂêàÔºö„ÄÜÊôÇÈñì„ÇíË°®Á§∫ --- %>
        <% if task.todo? && task.deadline.present? %>
         <div class="task-deadline-time" style="font-size: 0.75em; color: #d9534f; font-weight: bold; line-height: 1.2;">
          „ÄÜ <%= task.deadline.strftime("%H:%M") %>
         </div>
        <% end %>
        <%# „Çø„Ç§„Éà„É´ÈÉ®ÂàÜÔºàÂÑ™ÂÖàÂ∫¶„Ç¢„Ç§„Ç≥„É≥‰ªò„ÅçÔºâ %>
        <%= link_to task_path(task), class: "task-link" do %>
         <% if task.todo? && task.priority_high? %>
          <span title="ÂÑ™ÂÖàÂ∫¶ÔºöÈ´ò">üö©</span>
          <% end %>
         <%= task.title %>
         <% end %>
       </div>
      <% end %>
     </div>
    <% end %>
  </div>


<script>
  function setupDirectJump() {
    const titleElement = document.querySelector('.calendar-title');
    if (!titleElement || titleElement.querySelector('select')) return;

    const urlParams = new URLSearchParams(window.location.search);
    const text = titleElement.textContent;
    const defaultYear = text.match(/\d{4}/)?.[0];
    const defaultMonth = text.match(/\d{1,2}(?=Êúà)/)?.[0];

    const currentYear = urlParams.get('year') || defaultYear;
    const currentMonth = urlParams.get('month') || defaultMonth;

    const createSelect = (start, end, selected, name) => {
      let html = `<select class="select-jump ${name}">`;
      for (let i = start; i <= end; i++) {
        html += `<option value="${i}" ${i == selected ? 'selected' : ''}>${i}</option>`;
      }
      return html + `</select>`;
    };

    titleElement.innerHTML = `
      ${createSelect(2020, 2030, currentYear, 'year')}Âπ¥
      ${createSelect(1, 12, currentMonth, 'month')}Êúà
    `;

    // --- „Åì„Åì„Åã„ÇâËøΩÂä†ÔºöÂâçÊúà„ÉªÊ¨°Êúà„Éú„Çø„É≥„ÅÆ„É™„É≥„ÇØ‰øÆÊ≠£ ---
    const navLinks = document.querySelectorAll('.calendar-heading a');
    navLinks.forEach(link => {
      const href = link.getAttribute('href');
      const dateMatch = href.match(/start_date=(\d{4})-(\d{2})-\d{2}/);
      if (dateMatch) {
        // Gem„Åå‰Ωú„Å£„Åü„É™„É≥„ÇØ(start_date=YYYY-MM-DD)„Åã„ÇâÂπ¥„Å®Êúà„ÇíÊäΩÂá∫„Åó„Å¶Êõ∏„ÅçÊèõ„Åà„Çã
        const newYear = dateMatch[1];
        const newMonth = parseInt(dateMatch[2], 10);
        link.setAttribute('href', `${window.location.pathname}?year=${newYear}&month=${newMonth}`);
      }
    });
    // --- „Åì„Åì„Åæ„Åß ---

    titleElement.querySelectorAll('select').forEach(select => {
      select.addEventListener('change', () => {
        const year = titleElement.querySelector('.year').value;
        const month = titleElement.querySelector('.month').value;
        window.location.href = `${window.location.pathname}?year=${year}&month=${month}`;
      });
    });
  }

  document.addEventListener('turbo:load', setupDirectJump);
  document.addEventListener('turbo:render', setupDirectJump);
</script>