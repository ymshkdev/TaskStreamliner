<%# 1. ユーザー名表示 %>
<div class="user-info" style="margin-bottom: 20px;">
  <h2 style="font-size: 1.2rem; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
    <%= current_user.name %> さんの手帳
  </h2>
</div>

<%# 2. CSS読み込み %>
<%= stylesheet_link_tag "tasks_index" %>

<%# 3. カレンダーとサイドバーを囲む横並びコンテナ %>
<div class="dashboard-layout" data-controller="sidebar modal" data-sidebar-target="container">
  <%# 開くボタン %>
  <button type="button" class="toggle-button" data-action="click->sidebar#toggle">
    ☰ <small>メニュー</small>
  </button>

  <%# サイドバー本体 %>
  <aside class="task-sidebar">
    <%= render 'sidebar', todo_list: @todo_list %>
  </aside>

  <%# サイドバーが開いている時だけ出る「背景の黒い影」 %>
  <div class="sidebar-overlay" data-action="click->sidebar#close"></div>

  <%# --- 右：カレンダーコンテナ --- %>
  
  <div class="calendar-container" style="flex: 1; min-width: 0;">
  
  <%= month_calendar(events: @tasks, attribute: :start_time, start_date: @start_date) do |date, tasks| %>
    
    <div class="day-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
     <%# 左側：日付と祝日名 %>
     <div>
       <%# spanにday-numberクラスを追加して、土日の色設定が効くようにする HolidayJp.holiday?(date) で祝日判定。祝日なら 'holiday' クラスをつける %>
       <span class="day-number <%= 'sun' if date.sunday? %> <%= 'sat' if date.saturday? %> <%= 'holiday' if HolidayJp.holiday?(date) %>">
        <%# 日付をクリックしたらその日の詳細ページ（後ほど作成）へ飛ばすためのリンク（今は仮にnewへ） %>
        <%= link_to date.day, day_tasks_path(date: date), style: "text-decoration: none; color: inherit;" %>
       </span>
      <%# 祝日名を表示する %>
      <% if holiday = HolidayJp.between(date, date).first %>
       <div class="holiday-name" style="font-size: 0.6rem; color: #d32f2f; margin-top: 2px;">
        <%= holiday.name %>
       </div>
      <% end %>
     </div>
     <%# 右側：＋マーク（新規登録ページへ） %>
     <%= link_to new_task_path(selected_date: date), class: "add-task-btn", title: "新規登録", style: "text-decoration: none; color: #999;" do %>
      <span class="plus-icon" style="font-size: 1.2rem; line-height: 1;">&plus;</span>
     <% end %>
   </div>

    <div class="day-body">
  <% tasks.each do |task| %>
    <%= turbo_frame_tag dom_id(task) do %>
      <%= render partial: 'tasks/task_entry', locals: { task: task } %>
    <% end %>
  <% end %>
</div>
    <% end %>
  </div>

<%# サブメニュー %>
<div id="task-modal" 
     class="modal-overlay" 
     data-modal-target="overlay"
     data-action="click->modal#closeOutside">
  <div class="modal-content" data-modal-target="content">
    <%# 読み込み完了イベント(turbo:frame-load)をキャッチして再計算させる %>
    <%= turbo_frame_tag "modal_task_detail", 
                        data: { action: "turbo:frame-load->modal#reposition" } %>
  </div>
</div>

<script>
  function setupDirectJump() {
    const titleElement = document.querySelector('.calendar-title');
    if (!titleElement || titleElement.querySelector('select')) return;

    const urlParams = new URLSearchParams(window.location.search);
    const text = titleElement.textContent;
    const defaultYear = text.match(/\d{4}/)?.[0];
    const defaultMonth = text.match(/\d{1,2}(?=月)/)?.[0];

    const currentYear = urlParams.get('year') || defaultYear;
    const currentMonth = urlParams.get('month') || defaultMonth;

    const createSelect = (start, end, selected, name) => {
      let html = `<select class="select-jump ${name}">`;
      for (let i = start; i <= end; i++) {
        html += `<option value="${i}" ${i == selected ? 'selected' : ''}>${i}</option>`;
      }
      return html + `</select>`;
    };

    titleElement.innerHTML = `
      ${createSelect(2020, 2030, currentYear, 'year')}年
      ${createSelect(1, 12, currentMonth, 'month')}月
    `;

    // --- ここから追加：前月・次月ボタンのリンク修正 ---
    const navLinks = document.querySelectorAll('.calendar-heading a');
    navLinks.forEach(link => {
      const href = link.getAttribute('href');
      const dateMatch = href.match(/start_date=(\d{4})-(\d{2})-\d{2}/);
      if (dateMatch) {
        // Gemが作ったリンク(start_date=YYYY-MM-DD)から年と月を抽出して書き換える
        const newYear = dateMatch[1];
        const newMonth = parseInt(dateMatch[2], 10);
        link.setAttribute('href', `${window.location.pathname}?year=${newYear}&month=${newMonth}`);
      }
    });
    // --- ここまで ---

    titleElement.querySelectorAll('select').forEach(select => {
      select.addEventListener('change', () => {
        const year = titleElement.querySelector('.year').value;
        const month = titleElement.querySelector('.month').value;
        window.location.href = `${window.location.pathname}?year=${year}&month=${month}`;
      });
    });
  }

  document.addEventListener('turbo:load', setupDirectJump);
  document.addEventListener('turbo:render', setupDirectJump);
</script>