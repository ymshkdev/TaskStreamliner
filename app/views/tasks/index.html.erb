<%# 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º %>
<div class="user-info" style="margin-bottom: 20px;">
  <h2 style="font-size: 1.2rem; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
    <%= current_user.name %> ã•ã‚“ã®æ‰‹å¸³
  </h2>
</div>

<%# 2. CSSèª­ã¿è¾¼ã¿ %>
<%= stylesheet_link_tag "tasks_index" %>

<%# 3. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…¨ä½“ã‚’å›²ã‚€ã‚³ãƒ³ãƒ†ãƒŠ %>
<div class="calendar-container">
  
  <%= month_calendar(events: @tasks, attribute: :start_time, start_date: @start_date) do |date, tasks| %>
    
    <div class="day-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
     <%# å·¦å´ï¼šæ—¥ä»˜ã¨ç¥æ—¥å %>
     <div>
       <%# spanã«day-numberã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã¦ã€åœŸæ—¥ã®è‰²è¨­å®šãŒåŠ¹ãã‚ˆã†ã«ã™ã‚‹ HolidayJp.holiday?(date) ã§ç¥æ—¥åˆ¤å®šã€‚ç¥æ—¥ãªã‚‰ 'holiday' ã‚¯ãƒ©ã‚¹ã‚’ã¤ã‘ã‚‹ %>
       <span class="day-number <%= 'sun' if date.sunday? %> <%= 'sat' if date.saturday? %> <%= 'holiday' if HolidayJp.holiday?(date) %>">
        <%# æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãã®æ—¥ã®è©³ç´°ãƒšãƒ¼ã‚¸ï¼ˆå¾Œã»ã©ä½œæˆï¼‰ã¸é£›ã°ã™ãŸã‚ã®ãƒªãƒ³ã‚¯ï¼ˆä»Šã¯ä»®ã«newã¸ï¼‰ %>
        <%= link_to date.day, day_tasks_path(date: date), style: "text-decoration: none; color: inherit;" %>
       </span>
      <%# ç¥æ—¥åã‚’è¡¨ç¤ºã™ã‚‹ %>
      <% if holiday = HolidayJp.between(date, date).first %>
       <div class="holiday-name" style="font-size: 0.6rem; color: #d32f2f; margin-top: 2px;">
        <%= holiday.name %>
       </div>
      <% end %>
     </div>
     <%# å³å´ï¼šï¼‹ãƒãƒ¼ã‚¯ï¼ˆæ–°è¦ç™»éŒ²ãƒšãƒ¼ã‚¸ã¸ï¼‰ %>
     <%= link_to new_task_path(selected_date: date), class: "add-task-btn", title: "æ–°è¦ç™»éŒ²", style: "text-decoration: none; color: #999;" do %>
      <span class="plus-icon" style="font-size: 1.2rem; line-height: 1;">&plus;</span>
     <% end %>
   </div>

    <div class="day-body">
      <% tasks.each do |task| %>
       <div class="task-entry <%= task.task_type %> <%= "status-#{task.status}" if task.todo? %>">
        <%# äºˆå®šï¼ˆscheduleï¼‰ã‹ã¤é–‹å§‹æ™‚é–“ãŒã‚ã‚‹å ´åˆã€é–‹å§‹æ™‚é–“(HH:mm)~çµ‚äº†æ™‚é–“(HH:mm)ã‚’è¡¨ç¤º %>
        <% if task.schedule? && task.start_at.present? %>
         <span style="font-size: 0.8em; color: #666;">
          <%= task.start_at.strftime("%H:%M") %> ã€œ <%= task.end_at.strftime("%H:%M") %>
         </span>
        <% end %>

        <%# --- ã‚¿ã‚¹ã‚¯ (todo) ã®å ´åˆï¼šã€†æ™‚é–“ã‚’è¡¨ç¤º --- %>
        <% if task.todo? && task.deadline.present? %>
         <div class="task-deadline-time" style="font-size: 0.75em; color: #d9534f; font-weight: bold; line-height: 1.2;">
          ã€† <%= task.deadline.strftime("%H:%M") %>
         </div>
        <% end %>
        <%# ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ï¼ˆå„ªå…ˆåº¦ã‚¢ã‚¤ã‚³ãƒ³ä»˜ãï¼‰ %>
        <%= link_to task_path(task), class: "task-link" do %>
         <% if task.todo? && task.priority_high? %>
          <span title="å„ªå…ˆåº¦ï¼šé«˜">ğŸš©</span>
          <% end %>
         <%= task.title %>
         <% end %>
       </div>
      <% end %>
    </div>
    
  <% end %>
  
</div>

<hr>
<div class="todo-priority-list">
  <h3>ğŸ“Œ æœªå®Œäº†ã‚¿ã‚¹ã‚¯ï¼ˆå„ªå…ˆåº¦é †ï¼‰</h3>
  <ul>
    <% @todo_list.each do |todo| %>
      <li style="margin-bottom: 5px;">
        <%# å„ªå…ˆåº¦ã‚¢ã‚¤ã‚³ãƒ³ %>
        <% if todo.priority_high? %><span style="color: red;">ğŸš©</span><% end %>
        <% if todo.priority_middle? %><span style="color: orange;">ğŸ”¶</span><% end %>
        
        <%# ç· åˆ‡æ—¥ã¨ã‚¿ã‚¤ãƒˆãƒ« %>
        <small><%= todo.deadline.strftime("%m/%d") %>(<%= I18n.t('date.abbr_day_names')[todo.deadline.wday] %>) <%= todo.deadline.strftime("%H:%M") %></small>
        <strong><%= link_to todo.title, task_path(todo) %></strong>
        
        <%# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆæ—¥æœ¬èªï¼‰ %>
        <span class="badge" style="font-size: 0.8em; background: #eee;">
          <%= I18n.t "enums.task.status.#{todo.status}" %>
        </span>
      </li>
    <% end %>
  </ul>
</div>

<script>
  function setupDirectJump() {
    const titleElement = document.querySelector('.calendar-title');
    if (!titleElement || titleElement.querySelector('select')) return;

    const urlParams = new URLSearchParams(window.location.search);
    const text = titleElement.textContent;
    const defaultYear = text.match(/\d{4}/)?.[0];
    const defaultMonth = text.match(/\d{1,2}(?=æœˆ)/)?.[0];

    const currentYear = urlParams.get('year') || defaultYear;
    const currentMonth = urlParams.get('month') || defaultMonth;

    const createSelect = (start, end, selected, name) => {
      let html = `<select class="select-jump ${name}">`;
      for (let i = start; i <= end; i++) {
        html += `<option value="${i}" ${i == selected ? 'selected' : ''}>${i}</option>`;
      }
      return html + `</select>`;
    };

    titleElement.innerHTML = `
      ${createSelect(2020, 2030, currentYear, 'year')}å¹´
      ${createSelect(1, 12, currentMonth, 'month')}æœˆ
    `;

    // --- ã“ã“ã‹ã‚‰è¿½åŠ ï¼šå‰æœˆãƒ»æ¬¡æœˆãƒœã‚¿ãƒ³ã®ãƒªãƒ³ã‚¯ä¿®æ­£ ---
    const navLinks = document.querySelectorAll('.calendar-heading a');
    navLinks.forEach(link => {
      const href = link.getAttribute('href');
      const dateMatch = href.match(/start_date=(\d{4})-(\d{2})-\d{2}/);
      if (dateMatch) {
        // GemãŒä½œã£ãŸãƒªãƒ³ã‚¯(start_date=YYYY-MM-DD)ã‹ã‚‰å¹´ã¨æœˆã‚’æŠ½å‡ºã—ã¦æ›¸ãæ›ãˆã‚‹
        const newYear = dateMatch[1];
        const newMonth = parseInt(dateMatch[2], 10);
        link.setAttribute('href', `${window.location.pathname}?year=${newYear}&month=${newMonth}`);
      }
    });
    // --- ã“ã“ã¾ã§ ---

    titleElement.querySelectorAll('select').forEach(select => {
      select.addEventListener('change', () => {
        const year = titleElement.querySelector('.year').value;
        const month = titleElement.querySelector('.month').value;
        window.location.href = `${window.location.pathname}?year=${year}&month=${month}`;
      });
    });
  }

  document.addEventListener('turbo:load', setupDirectJump);
  document.addEventListener('turbo:render', setupDirectJump);
</script>