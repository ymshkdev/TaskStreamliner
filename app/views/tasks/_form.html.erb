<div class="task-form-container">
  <%= form_with(model: task, local: true) do |f| %>
    <%# エラー表示（以前のものを継続） %>
    <%# --- 追加：戻り先情報をコントローラーに引き渡す --- %>
    <%= hidden_field_tag :return_to, @return_to %>
    <%= hidden_field_tag :start_date, @start_date %>
    <% if task.errors.any? %>
      <div id="error_explanation" style="color: red;">
        <ul>
          <% task.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%# 1. タイプの選択（タスク or 予定） %>
    <div class="field">
      <%= f.label :task_type, "登録内容" %>
      <div class="radio-group">
       <div class="radio-option">
        <%# id: "type_todo" を指定 %>
        <%= f.radio_button :task_type, :todo, checked: task.todo?, class: "type-selector", id: "type_todo" %>
        <%# for: "type_todo" を指定することで、このラベルをクリックしても上のボタンが反応するように %>
        <%= f.label :task_type, "タスク（締切あり）", for: "type_todo" %>
       </div>
       <div class="radio-option">
        <%# id: "type_schedule" を指定 %>
        <%= f.radio_button :task_type, :schedule, checked: task.schedule?, class: "type-selector", id: "type_schedule" %>
        <%# for: "type_schedule" を指定 %>
        <%= f.label :task_type, "予定（開始・終了あり）", for: "type_schedule" %>
       </div>
      </div>
    </div>

    <div class="field">
      <%= f.label :title %>
      <%= f.text_field :title %>
    </div>

    <%# 2. タスク（todo）用の項目 %>
    <div id="todo-fields" class="type-fields">
      <div class="field">
       <%= f.label :deadline %>
       <%= f.datetime_local_field :deadline, 
        # エラーで消えていても、URLに日付があればそれを表示する
        value: @task.deadline&.strftime('%Y-%m-%dT%H:%M') || (params[:deadline] ? "#{params[:deadline]}T23:59" : nil),
        class: "form-control deadline-input" %>
      </div>
    </div>

    <%# 3. 予定（schedule）用の項目 %>
    <div id="schedule-fields" class="type-fields" style="display: none;">
      <div class="field">
        <%= f.label :start_at %>
        <%= f.datetime_local_field :start_at %>
      </div>
      <div class="field">
        <%= f.label :end_at %>
        <%= f.datetime_local_field :end_at %>
      </div>
    </div>

    <div class="field">
      <%= f.label :description %>
      <%= f.text_area :description %>
    </div>

    <div class="field">
      <%= f.label :priority %>
      <%= f.select :priority, Task.priorities.keys.map { |k| [I18n.t("enums.task.priority.#{k}"), k] } %>
    </div>

    <%# ステータス選択（タスクの時だけ表示したいのでIDを付与） %>
    <div id="status-field" class="field">
     <%= f.label :status %>
     <%= f.select :status, 
               Task.statuses.keys.map { |k| [I18n.t("enums.task.status.#{k}"), k] }, 
               {}, 
               class: "form-control" %>
    </div>

    <div class="actions">
      <%= f.submit "保存する", class: "submit-btn" %>
      <% if @return_to == 'day' %>
      <%# dayページから来た場合は、表示していた日(@date)と表示していた月(@start_date)に戻す %>
      <%= link_to 'キャンセル', day_tasks_path(date: task.start_at&.to_date || task.deadline&.to_date || Date.today, start_date: @start_date), class: "cancel-link" %>
      <% else %>
      <%# それ以外（index）から来た場合は、通常のカレンダー画面に戻す %>
      <%= link_to 'キャンセル', tasks_path(start_date: @start_date), class: "cancel-link" %>
      <% end %>
    </div>
  <% end %>
</div>

<%# JavaScriptで表示・非表示を切り替え %>
<script>
  function applyTaskTypeFields() {
    const todoFields = document.getElementById('todo-fields');
    const scheduleFields = document.getElementById('schedule-fields');
    const statusField = document.getElementById('status-field');
    const checkedElement = document.querySelector('.type-selector:checked');
    
    // 両方の入力欄を取得
    const startAtInput = document.querySelector('input[name="task[start_at]"]');
    const deadlineInput = document.querySelector('input[name="task[deadline]"]');
    
    const urlParams = new URLSearchParams(window.location.search);
    const selectedDate = urlParams.get('deadline');

    if (todoFields && scheduleFields && checkedElement) {
      if (checkedElement.value === 'todo') {
        // --- タスクの場合 ---
        todoFields.style.display = 'block';
        scheduleFields.style.display = 'none';
        if (statusField) statusField.style.display = 'block'; // ステータスを表示
        if (selectedDate && deadlineInput && !deadlineInput.value) { // タスクに切り替えた際、もし締切が空（エラーで消された等）ならURLの日付で復元
          deadlineInput.value = `${selectedDate}T00:00`;
        }
      } else {
        // --- 予定（スケジュール）の場合 ---
        todoFields.style.display = 'none';
        scheduleFields.style.display = 'block';

        // ポイント：
        // 1. URLに日付がある（カレンダー経由）
        // 2. まだ入力欄が空（初めて切り替えた）
        // この時だけ自動セット。入力エラーで戻った時は input に値が入っているので上書きされない。
        if (statusField) statusField.style.display = 'none'; // ステータスを非表示にする
        if (selectedDate && startAtInput && !startAtInput.value) {
          startAtInput.value = `${selectedDate}T09:00`;
          handleAutoFill(); 
        }
      }
    }
  }

  function setupTimeAutoFill() {
    const startAtInput = document.querySelector('input[name="task[start_at]"]');
    if (startAtInput) {
      startAtInput.removeEventListener('change', handleAutoFill);
      startAtInput.addEventListener('change', handleAutoFill);
    }
  }

  function handleAutoFill() {
    const startAtInput = document.querySelector('input[name="task[start_at]"]');
    const endAtInput = document.querySelector('input[name="task[end_at]"]');
    
    // 終了時間が空の時だけ自動計算
    if (startAtInput && startAtInput.value && endAtInput) {
      const startDate = new Date(startAtInput.value);
      startDate.setHours(startDate.getHours() + 1);
      
      const year = startDate.getFullYear();
      const month = String(startDate.getMonth() + 1).padStart(2, '0');
      const day = String(startDate.getDate()).padStart(2, '0');
      const hours = String(startDate.getHours()).padStart(2, '0');
      const minutes = String(startDate.getMinutes()).padStart(2, '0');
      
      endAtInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }
  }

  function setupTypeSelectorEvents() {
    document.querySelectorAll('.type-selector').forEach(el => {
      el.removeEventListener('change', applyTaskTypeFields);
      el.addEventListener('change', applyTaskTypeFields);
    });
  }

  // --- 実行指示（load/render両方対応） ---
  document.addEventListener('turbo:load', () => {
    applyTaskTypeFields();
    setupTypeSelectorEvents();
    setupTimeAutoFill();
  });

  document.addEventListener('turbo:render', () => {
    applyTaskTypeFields();
    setupTypeSelectorEvents();
    setupTimeAutoFill();
  });
</script>